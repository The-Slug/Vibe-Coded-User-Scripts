// ==UserScript==
// @name         ChatGPT Message Collapser
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Add expand/collapse buttons to ChatGPT messages
// @author       Claude Opus 4.5 (Vibecoded via Alexander Slugworth)
// @match        https://chatgpt.com/*
// @match        https://chat.openai.com/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // Track collapsed state by turn ID (persists across React re-renders)
    const collapsedTurns = new Set();

    // Inject styles manually since GM_addStyle isn't available
    function injectStyles() {
        if (document.getElementById('cgpt-collapse-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'cgpt-collapse-styles';
        style.textContent = `
            /* Global controls wrapper - separate element before articles */
            .cgpt-collapse-global-wrapper {
                width: 100%;
                max-width: 48rem;
                margin: 0 auto;
                padding: 10px 0 10px 0;
                position: relative;
            }

            .cgpt-collapse-global-controls {
                display: flex;
                gap: 8px;
                margin-left: -36px;
            }

            /* Base button style (light - for collapse state) */
            .cgpt-collapse-global-btn {
                padding: 6px 14px;
                border: 1px solid var(--border-medium, #d1d5db);
                border-radius: 6px;
                background: var(--main-surface-secondary, #f9fafb);
                color: var(--text-primary, #374151);
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.15s ease;
                text-align: center;
            }

            .cgpt-collapse-global-btn:hover {
                background: var(--main-surface-tertiary, #f3f4f6);
                border-color: var(--border-heavy, #9ca3af);
            }

            /* Fixed widths for buttons to prevent size changes */
            .cgpt-collapse-global-btn.cgpt-all-btn {
                min-width: 115px;
            }

            .cgpt-collapse-global-btn.cgpt-ai-btn {
                min-width: 115px;
            }

            .cgpt-collapse-global-btn.cgpt-user-btn {
                min-width: 110px;
            }

            /* Dark button style (for expand state) */
            .cgpt-collapse-global-btn.cgpt-btn-dark {
                background: #374151;
                border-color: #374151;
                color: #ffffff;
            }

            .cgpt-collapse-global-btn.cgpt-btn-dark:hover {
                background: #4b5563;
                border-color: #4b5563;
            }

            /* Toggle button styles - default (expanded) state */
            .cgpt-collapse-toggle {
                position: absolute;
                left: -36px;
                top: 8px;
                width: 22px;
                height: 22px;
                border: 1px solid var(--border-medium, #d1d5db);
                border-radius: 4px;
                background: var(--main-surface-secondary, #f9fafb);
                color: var(--text-secondary, #6b7280);
                font-size: 14px;
                font-weight: 600;
                line-height: 1;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.15s ease;
                z-index: 10;
            }

            .cgpt-collapse-toggle:hover {
                background: var(--main-surface-tertiary, #e5e7eb);
                border-color: var(--border-heavy, #9ca3af);
            }

            /* Toggle button - collapsed state (dark with white text) */
            article[data-turn].cgpt-collapsed .cgpt-collapse-toggle {
                background: #374151;
                border-color: #374151;
                color: #ffffff;
            }

            article[data-turn].cgpt-collapsed .cgpt-collapse-toggle:hover {
                background: #4b5563;
                border-color: #4b5563;
            }

            /* Horizontal connector bar for expanded user messages - full width behind bubble */
            article[data-turn="user"]:not(.cgpt-collapsed) [class*="thread-content-max-width"]::before {
                content: '';
                position: absolute;
                left: -36px;
                right: 0;
                top: 18px;
                height: 2px;
                background: #f9f9f9;
                z-index: 0;
            }

            /* Ensure relative positioning for toggle placement */
            article[data-turn] [class*="thread-content-max-width"] {
                position: relative;
            }

            /* Hide original text when collapsed, show our cloned preview */
            article[data-turn].cgpt-collapsed .cgpt-original-content {
                display: none !important;
            }

            article[data-turn] .cgpt-collapsed-preview {
                display: none;
            }

            /* Collapsed preview - use flexbox to keep ellipsis visible */
            article[data-turn].cgpt-collapsed .cgpt-collapsed-preview {
                display: flex !important;
                flex-direction: row;
                align-items: baseline;
                max-width: 100%;
                overflow: hidden;
            }

            /* Text part truncates with ellipsis */
            .cgpt-collapsed-preview .cgpt-preview-text {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
                min-width: 0;
            }

            /* Ellipsis marker stays visible and doesn't shrink */
            .cgpt-collapsed-preview .cgpt-ellipsis {
                font-weight: 700 !important;
                color: var(--text-secondary, #6b7280) !important;
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* Collapsed outline - use ::before pseudo-element for proper extended background */
            article[data-turn="user"].cgpt-collapsed [class*="thread-content-max-width"] > [class*="flex"] {
                position: relative;
            }

            article[data-turn="user"].cgpt-collapsed [class*="thread-content-max-width"] > [class*="flex"]::before {
                content: '';
                position: absolute;
                top: -4px;
                bottom: -4px;
                left: -9px;
                right: -4px;
                border: 2px solid rgba(55, 65, 81, 0.5);
                border-radius: 12px;
                background: var(--main-surface-primary, #ffffff);
                z-index: -1;
            }

            article[data-turn="assistant"].cgpt-collapsed [class*="thread-content-max-width"] > [class*="flex"] {
                position: relative;
            }

            article[data-turn="assistant"].cgpt-collapsed [class*="thread-content-max-width"] > [class*="flex"]::before {
                content: '';
                position: absolute;
                top: -4px;
                bottom: -4px;
                left: -9px;
                right: -4px;
                border: 2px solid rgba(107, 114, 128, 0.35);
                border-radius: 12px;
                background: var(--main-surface-primary, #ffffff);
                z-index: -1;
            }

            /* Hide action buttons when collapsed */
            article.cgpt-collapsed .z-0 {
                display: none !important;
            }

            /* Dark mode adjustments */
            .dark .cgpt-collapse-global-btn {
                background: var(--main-surface-secondary, #2f2f2f);
                border-color: var(--border-medium, #4a4a4a);
                color: var(--text-primary, #ececec);
            }

            .dark .cgpt-collapse-global-btn:hover {
                background: var(--main-surface-tertiary, #3a3a3a);
            }

            /* Dark mode - dark button style (inverted for contrast) */
            .dark .cgpt-collapse-global-btn.cgpt-btn-dark {
                background: #e5e7eb;
                border-color: #e5e7eb;
                color: #1f2937;
            }

            .dark .cgpt-collapse-global-btn.cgpt-btn-dark:hover {
                background: #f3f4f6;
                border-color: #f3f4f6;
            }

            .dark .cgpt-collapse-toggle {
                background: var(--main-surface-secondary, #2f2f2f);
                border-color: var(--border-medium, #4a4a4a);
                color: var(--text-secondary, #b4b4b4);
            }

            .dark .cgpt-collapse-toggle:hover {
                background: var(--main-surface-tertiary, #3a3a3a);
            }

            /* Dark mode - collapsed toggle button (light with dark text for contrast) */
            .dark article[data-turn].cgpt-collapsed .cgpt-collapse-toggle {
                background: #e5e7eb;
                border-color: #e5e7eb;
                color: #1f2937;
            }

            .dark article[data-turn].cgpt-collapsed .cgpt-collapse-toggle:hover {
                background: #f3f4f6;
                border-color: #f3f4f6;
            }

            /* Dark mode connector bar */
            .dark article[data-turn="user"]:not(.cgpt-collapsed) [class*="thread-content-max-width"]::before {
                background: #3a3a3a;
            }

            .dark article[data-turn="user"].cgpt-collapsed [class*="thread-content-max-width"] > [class*="flex"]::before {
                border-color: rgba(200, 200, 200, 0.45);
                background: var(--main-surface-primary, #212121);
            }

            .dark article[data-turn="assistant"].cgpt-collapsed [class*="thread-content-max-width"] > [class*="flex"]::before {
                border-color: rgba(160, 160, 160, 0.3);
                background: var(--main-surface-primary, #212121);
            }

            .dark .cgpt-collapsed-preview .cgpt-ellipsis {
                color: var(--text-secondary, #b4b4b4) !important;
            }
        `;
        document.head.appendChild(style);
    }

    // Update button states based on current collapsed state
    function updateGlobalButtonStates() {
        const allBtn = document.querySelector('.cgpt-all-btn');
        const aiBtn = document.querySelector('.cgpt-ai-btn');
        const userBtn = document.querySelector('.cgpt-user-btn');
        
        if (allBtn) {
            const allArticles = document.querySelectorAll('article[data-turn]');
            const allCollapsedNow = allArticles.length > 0 && 
                Array.from(allArticles).every(a => a.classList.contains('cgpt-collapsed'));
            
            allBtn.textContent = allCollapsedNow ? '+ Expand All' : 'âˆ’ Collapse All';
            allBtn.classList.toggle('cgpt-btn-dark', allCollapsedNow);
        }
        
        if (aiBtn) {
            const aiArticles = document.querySelectorAll('article[data-turn="assistant"]');
            const aiCollapsedNow = aiArticles.length > 0 && 
                Array.from(aiArticles).every(a => a.classList.contains('cgpt-collapsed'));
            
            aiBtn.textContent = aiCollapsedNow ? '+ Expand ðŸ¤–' : 'âˆ’ Collapse ðŸ¤–';
            aiBtn.classList.toggle('cgpt-btn-dark', aiCollapsedNow);
        }

        if (userBtn) {
            const userArticles = document.querySelectorAll('article[data-turn="user"]');
            const userCollapsedNow = userArticles.length > 0 && 
                Array.from(userArticles).every(a => a.classList.contains('cgpt-collapsed'));
            
            userBtn.textContent = userCollapsedNow ? '+ Expand ðŸ§‘' : 'âˆ’ Collapse ðŸ§‘';
            userBtn.classList.toggle('cgpt-btn-dark', userCollapsedNow);
        }
    }

    // Create the global collapse/expand controls
    function createGlobalControls() {
        // Check if controls already exist
        if (document.querySelector('.cgpt-collapse-global-wrapper')) {
            return;
        }

        // Create wrapper structure
        const wrapper = document.createElement('div');
        wrapper.className = 'cgpt-collapse-global-wrapper';

        const controlsContainer = document.createElement('div');
        controlsContainer.className = 'cgpt-collapse-global-controls';

        // All messages toggle button
        const allBtn = document.createElement('button');
        allBtn.className = 'cgpt-collapse-global-btn cgpt-all-btn';
        allBtn.textContent = 'âˆ’ Collapse All';
        allBtn.addEventListener('click', () => {
            const allArticles = document.querySelectorAll('article[data-turn]');
            const allCollapsedNow = allArticles.length > 0 && 
                Array.from(allArticles).every(a => a.classList.contains('cgpt-collapsed'));
            
            allArticles.forEach(article => {
                const turnId = article.getAttribute('data-turn-id');
                if (allCollapsedNow) {
                    article.classList.remove('cgpt-collapsed');
                    collapsedTurns.delete(turnId);
                } else {
                    article.classList.add('cgpt-collapsed');
                    collapsedTurns.add(turnId);
                }
                const toggle = article.querySelector('.cgpt-collapse-toggle');
                if (toggle) toggle.textContent = allCollapsedNow ? 'âˆ’' : '+';
            });
            updateGlobalButtonStates();
        });

        // AI messages only toggle button
        const aiBtn = document.createElement('button');
        aiBtn.className = 'cgpt-collapse-global-btn cgpt-ai-btn';
        aiBtn.textContent = 'âˆ’ Collapse ðŸ¤–';
        aiBtn.addEventListener('click', () => {
            const aiArticles = document.querySelectorAll('article[data-turn="assistant"]');
            const aiCollapsedNow = aiArticles.length > 0 && 
                Array.from(aiArticles).every(a => a.classList.contains('cgpt-collapsed'));
            
            aiArticles.forEach(article => {
                const turnId = article.getAttribute('data-turn-id');
                if (aiCollapsedNow) {
                    article.classList.remove('cgpt-collapsed');
                    collapsedTurns.delete(turnId);
                } else {
                    article.classList.add('cgpt-collapsed');
                    collapsedTurns.add(turnId);
                }
                const toggle = article.querySelector('.cgpt-collapse-toggle');
                if (toggle) toggle.textContent = aiCollapsedNow ? 'âˆ’' : '+';
            });
            updateGlobalButtonStates();
        });

        // User messages only toggle button
        const userBtn = document.createElement('button');
        userBtn.className = 'cgpt-collapse-global-btn cgpt-user-btn';
        userBtn.textContent = 'âˆ’ Collapse ðŸ§‘';
        userBtn.addEventListener('click', () => {
            const userArticles = document.querySelectorAll('article[data-turn="user"]');
            const userCollapsedNow = userArticles.length > 0 && 
                Array.from(userArticles).every(a => a.classList.contains('cgpt-collapsed'));
            
            userArticles.forEach(article => {
                const turnId = article.getAttribute('data-turn-id');
                if (userCollapsedNow) {
                    article.classList.remove('cgpt-collapsed');
                    collapsedTurns.delete(turnId);
                } else {
                    article.classList.add('cgpt-collapsed');
                    collapsedTurns.add(turnId);
                }
                const toggle = article.querySelector('.cgpt-collapse-toggle');
                if (toggle) toggle.textContent = userCollapsedNow ? 'âˆ’' : '+';
            });
            updateGlobalButtonStates();
        });

        controlsContainer.appendChild(allBtn);
        controlsContainer.appendChild(aiBtn);
        controlsContainer.appendChild(userBtn);
        wrapper.appendChild(controlsContainer);

        // Insert before the first article
        const firstArticle = document.querySelector('article[data-turn]');
        if (firstArticle && firstArticle.parentNode) {
            firstArticle.parentNode.insertBefore(wrapper, firstArticle);
        }
    }

    // Extract text content from an element
    function getTextContent(element) {
        if (!element) return '';
        return element.textContent || element.innerText || '';
    }

    // Create the preview element properly using DOM methods (not innerHTML)
    function createPreviewElement(text) {
        const preview = document.createElement('div');
        preview.className = 'cgpt-collapsed-preview';
        
        const textSpan = document.createElement('span');
        textSpan.className = 'cgpt-preview-text';
        textSpan.textContent = text;
        
        const ellipsisSpan = document.createElement('span');
        ellipsisSpan.className = 'cgpt-ellipsis';
        ellipsisSpan.textContent = ' [...]';
        
        preview.appendChild(textSpan);
        preview.appendChild(ellipsisSpan);
        
        return preview;
    }

    // Setup or restore an article's collapse functionality
    function setupArticle(article) {
        const turnId = article.getAttribute('data-turn-id');
        const turnType = article.getAttribute('data-turn');
        const isCollapsed = collapsedTurns.has(turnId);
        
        // Find the content container
        const innerDiv = article.querySelector('[class*="thread-content-max-width"]');
        if (!innerDiv) return;

        // Add or update toggle button
        let toggle = article.querySelector('.cgpt-collapse-toggle');
        if (!toggle) {
            toggle = document.createElement('button');
            toggle.className = 'cgpt-collapse-toggle';
            toggle.title = 'Toggle collapse';
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const currentlyCollapsed = article.classList.contains('cgpt-collapsed');
                if (currentlyCollapsed) {
                    article.classList.remove('cgpt-collapsed');
                    collapsedTurns.delete(turnId);
                    toggle.textContent = 'âˆ’';
                } else {
                    article.classList.add('cgpt-collapsed');
                    collapsedTurns.add(turnId);
                    toggle.textContent = '+';
                }
                updateGlobalButtonStates();
            });
            innerDiv.appendChild(toggle);
        }
        
        // Set toggle text based on state
        toggle.textContent = isCollapsed ? '+' : 'âˆ’';
        
        // Apply collapsed class if needed
        if (isCollapsed) {
            article.classList.add('cgpt-collapsed');
        } else {
            article.classList.remove('cgpt-collapsed');
        }

        // Find the content element based on message type
        let contentElement = null;
        let contentContainer = null;

        if (turnType === 'user') {
            // For user messages, find the whitespace-pre-wrap that's NOT our preview
            const allWhitespace = article.querySelectorAll('.whitespace-pre-wrap');
            for (const el of allWhitespace) {
                if (!el.classList.contains('cgpt-collapsed-preview') && 
                    !el.closest('.cgpt-collapsed-preview')) {
                    contentElement = el;
                    break;
                }
            }
            contentContainer = contentElement?.closest('.user-message-bubble-color') || 
                              contentElement?.closest('[class*="user-message"]') ||
                              contentElement?.parentElement;
        } else if (turnType === 'assistant') {
            contentElement = article.querySelector('.markdown');
            contentContainer = contentElement?.parentElement;
        }

        if (contentElement && contentContainer) {
            // Mark the original content (may need to re-add after React re-render)
            if (!contentElement.classList.contains('cgpt-original-content')) {
                contentElement.classList.add('cgpt-original-content');
            }

            // Remove any existing preview and recreate it cleanly
            const existingPreviews = contentContainer.querySelectorAll('.cgpt-collapsed-preview');
            existingPreviews.forEach(p => p.remove());
            
            // Get the preview text
            const fullText = getTextContent(contentElement);
            const firstLine = fullText.split('\n')[0].trim();
            const truncatedText = firstLine.length > 100 ? firstLine.substring(0, 100) : firstLine;
            
            // Create preview using DOM methods (not innerHTML)
            const preview = createPreviewElement(truncatedText);
            contentContainer.appendChild(preview);
        }
    }

    // Process all articles in the conversation
    function processArticles() {
        const articles = document.querySelectorAll('article[data-turn]');
        articles.forEach(setupArticle);

        // Also ensure global controls exist
        if (articles.length > 0) {
            createGlobalControls();
            updateGlobalButtonStates();
        }
    }

    // Initialize
    function init() {
        injectStyles();
        processArticles();

        // Watch for DOM changes (new messages, React re-renders)
        const observer = new MutationObserver((mutations) => {
            let shouldProcess = false;
            
            for (const mutation of mutations) {
                // Check for added nodes
                if (mutation.addedNodes.length > 0) {
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.matches?.('article[data-turn]') ||
                                node.querySelector?.('article[data-turn]') ||
                                node.matches?.('.markdown') ||
                                node.closest?.('article[data-turn]')) {
                                shouldProcess = true;
                                break;
                            }
                        }
                    }
                }
                
                // Check for modifications to existing articles (React re-renders)
                if (mutation.type === 'childList' && mutation.target.closest?.('article[data-turn]')) {
                    shouldProcess = true;
                }
                
                if (shouldProcess) break;
            }
            
            if (shouldProcess) {
                // Small delay to let React finish rendering
                setTimeout(processArticles, 50);
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    // Wait for page to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        // Small delay to ensure ChatGPT's React has rendered
        setTimeout(init, 500);
    }

    // Also re-run when navigating between chats (SPA navigation)
    let lastUrl = location.href;
    new MutationObserver(() => {
        const url = location.href;
        if (url !== lastUrl) {
            lastUrl = url;
            // Clear collapsed state for new chat
            collapsedTurns.clear();
            setTimeout(() => {
                // Remove old global controls when navigating
                const oldControls = document.querySelector('.cgpt-collapse-global-wrapper');
                if (oldControls) oldControls.remove();
                processArticles();
            }, 500);
        }
    }).observe(document, { subtree: true, childList: true });

})();
